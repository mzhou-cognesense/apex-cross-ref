<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Part Cross‑Reference — OLD↔NEW</title>
  <style>
    :root{--bg:#0f172a;--panel:#0b1220;--ink:#e5e7eb;--muted:#94a3b8;--line:#1f2937;--accent:#1d4ed8}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,#0b1024,#0f172a);color:var(--ink)}
    header{padding:22px 16px;text-align:center}
    h1{margin:0 0 6px;font-size:24px}
    .hint{color:var(--muted);font-size:13px}
    .wrap{max-width:1100px;margin:0 auto;padding:0 16px 40px}
    .panel{background:rgba(11,18,32,.95);backdrop-filter:saturate(140%) blur(6px);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;padding:12px;border-bottom:1px solid var(--line)}
    input[type="text"]{flex:1;min-width:220px;padding:11px 12px;border-radius:12px;border:1px solid #334155;background:#0b1220;color:var(--ink)}
    .btn{padding:10px 12px;border-radius:12px;border:1px solid #334155;background:#0b1220;color:var(--ink);cursor:pointer}
    .btn.primary{background:var(--accent);border-color:#2563eb}
    .tabs{display:flex;gap:8px;margin-right:auto}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid #334155;cursor:pointer;background:#0b1220;color:var(--ink);font-weight:600}
    .tab.active{background:var(--accent);border-color:#2563eb}
    .badge{font-size:12px;border:1px solid #334155;border-radius:999px;padding:2px 8px;color:#93c5fd;background:#0b1220;margin-left:auto}
    .meta{display:flex;justify-content:space-between;gap:12px;padding:10px 14px;border-bottom:1px solid var(--line);color:var(--muted);font-size:13px}
    .section{padding:14px}
    .result{display:grid;grid-template-columns: 220px 1fr;gap:8px;border:1px solid var(--line);border-radius:12px;padding:12px;background:#0b1220}
    .k{color:#93c5fd}.v{color:var(--ink)}
    .list{display:flex;flex-direction:column;gap:10px}
    .msg{padding:12px;border:1px dashed #334155;border-radius:10px;color:var(--muted);background:#0b1220}
    .grid{width:100%;border-collapse:separate;border-spacing:0}
    th{position:sticky;top:0;text-align:left;background:#0b1220;color:#93c5fd;border-bottom:1px solid var(--line);padding:8px}
    td{border-bottom:1px dashed #1f2937;padding:8px;vertical-align:top}
    code{background:#0b1220;border:1px solid #334155;border-radius:6px;padding:1px 6px}
    footer{padding:20px;text-align:center;color:var(--muted);font-size:12px}
    code.copy{cursor:pointer;position:relative}
    code.copy:hover{border-color:#60a5fa}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;
    padding:10px 14px;border:1px solid #1f2937;border-radius:999px;
    background:#0b1220;color:#fff;box-shadow:0 10px 20px rgba(0,0,0,.35);
    opacity:0;pointer-events:none;transition:opacity .25s}
    .toast.show{opacity:1}
  </style>
</head>
<body>
<header>
  <h1>Part Cross‑Reference</h1>
  <div class="hint">Enter a part number. Modes: <b>OLD → NEW</b> or <b>NEW → OLD</b>. Data auto‑loads from <code>parts.csv</code>.</div>
</header>

<div class="wrap">
  <div class="panel">
    <div class="toolbar">
      <div class="tabs">
        <button class="tab active" id="tab-oldnew">OLD → NEW</button>
        <button class="tab" id="tab-newold">NEW → OLD</button>
      </div>
      <input id="q" type="text" placeholder="Enter part number…" autocomplete="off" />
      <button id="search" class="btn primary">Search</button>
      <span id="badge" class="badge">Loading…</span>
    </div>

    <div class="meta">
      <div>Rows: <span id="rowCount">0</span></div>
      <div>Mode: <b id="modeName">OLD → NEW</b> • Normalized: <code id="normPreview">—</code></div>
    </div>

    <div class="section">
      <div id="results"></div>
    </div>
  </div>
  <footer>Update data by replacing <code>parts.csv</code> in this repository.</footer>
</div>

<script>
function normalize(s){ return String(s||"").replace(/[^A-Za-z0-9]/g,"").toUpperCase(); }

function detectDelimiter(text){
  const firstBreak = text.search(/\r\n|\n|\r/);
  const firstLine = firstBreak === -1 ? text : text.slice(0, firstBreak);
  const counts = {',':0,';':0,'\t':0};
  for(const ch of firstLine){ if(ch===',') counts[',']++; else if(ch===';') counts[';']++; }
  counts['\t'] = (firstLine.match(/\t/g)||[]).length;
  let delim = ',', max = counts[','];
  if(counts[';'] > max){ delim = ';'; max = counts[';']; }
  if(counts['\t'] > max){ delim = '\t'; max = counts['\t']; }
  return delim;
}

function parseCSV(text){
  const delim = detectDelimiter(text);
  const rows = []; let i=0, ch, inQ=false, field='', row=[];
  const D = (delim==='\t') ? '\t' : delim;
  function pushField(){ row.push(field); field=''; }
  function pushRow(){ rows.push(row); row=[]; }
  while(i<text.length){
    ch = text[i];
    if(inQ){
      if(ch === '"'){ if(text[i+1] === '"'){ field+='"'; i+=2; continue; } inQ=false; i++; continue; }
      field += ch; i++; continue;
    }else{
      if(ch === '"'){ inQ=true; i++; continue; }
      if((D==='\t' && ch==='\t') || (D!=='\t' && ch===D)){ pushField(); i++; continue; }
      if(ch==='\r'){ if(text[i+1]==='\n') i++; pushField(); pushRow(); i++; continue; }
      if(ch==='\n'){ pushField(); pushRow(); i++; continue; }
      field += ch; i++; continue;
    }
  }
  if(field.length>0 || row.length>0){ pushField(); pushRow(); }

  const header = rows.shift().map(h=>h.trim());
  const objs = rows.filter(r=>r.length && r.some(x=>x!=='')).map(cols=>{
    const o={}; header.forEach((h,idx)=>o[h]=(cols[idx]||'').trim()); return o;
  });
  return {header, rows: objs};
}

const TARGET = ["Part#","Product#","Product Line","Status","Standard","Non Standard","Sample","Details 1","Details 2"];
const SYN = {
  "Part#": ["part#","part #","partnumber","part number","part_no","partno","old part","old part#","old part number"],
  "Product#": ["product#","product #","product id","productid","product number"],
  "Product Line": ["product line","line","family","productline"],
  "Status": ["status","state"],
  "Standard": ["standard","new part","new part#","newpart","replacement","replacement part","new"],
  "Non Standard": ["non standard","non-standard","ns info","custom","custom info"],
  "Sample": ["sample","sample part","sample info","sample#"],
  "Details 1": ["details 1","detail 1","desc","description","info 1","notes 1"],
  "Details 2": ["details 2","detail 2","info 2","notes 2","extra"]
};
function canon(s){ return s.toLowerCase().replace(/[^a-z0-9]+/g,'').trim(); }
function buildHeaderMap(header){
  const map = {}; const canonHeader = header.map(h => ({raw:h, c: canon(h)}));
  for(const t of TARGET){
    const opts = [canon(t), ...((SYN[t]||[]).map(canon))];
    const found = canonHeader.find(h => opts.includes(h.c));
    if(found) map[t] = found.raw;
  }
  return map;
}

const STATE = { mode:'OLDNEW', rows:[], mapOld:new Map(), mapNew:new Map(), headerMap:{}};
function get(r, key){ const h = STATE.headerMap[key]; return h ? (r[h] ?? '') : ''; }

function indexData(){
  STATE.mapOld = new Map(); STATE.mapNew = new Map();
  for(const r of STATE.rows){
    const kOld = normalize(get(r,"Part#")); if(kOld){ if(!STATE.mapOld.has(kOld)) STATE.mapOld.set(kOld, []); STATE.mapOld.get(kOld).push(r); }
    const kNew = normalize(get(r,"Standard")); if(kNew){ if(!STATE.mapNew.has(kNew)) STATE.mapNew.set(kNew, []); STATE.mapNew.get(kNew).push(r); }
  }
}

function setBadge(t){ document.getElementById('badge').textContent = t; }
function showMsg(el, text){ el.innerHTML = `<div class="msg">${text}</div>`; }

function loadCSVText(text){
  const parsed = parseCSV(text);
  STATE.headerMap = buildHeaderMap(parsed.header);
  STATE.rows = parsed.rows;
  indexData();
  document.getElementById('rowCount').textContent = String(STATE.rows.length);
  document.getElementById('results').innerHTML = '';
  setBadge('Ready');
}

function renderOldToNew(container, inputRaw){
  const norm = normalize(inputRaw);
  document.getElementById('normPreview').textContent = norm || '—';
  if(!norm){ showMsg(container, 'Enter an old part number to search.'); return; }
  const hits = STATE.mapOld.get(norm) || [];
  if(hits.length === 0){ showMsg(container, `No results for “${inputRaw}”. (normalized: ${norm})`); return; }

  const list = document.createElement('div'); list.className='list';
  for(const r of hits){
    const status = String(get(r,"Status")).trim();
    const isStandard = status.toLowerCase()==='standard';
    const isSP = status.toUpperCase()==='SP';
    let body = '';
    if(isStandard){
      body = `<div class="k">Status</div><div class="v"><b>${get(r,"Status")}</b></div>
              <div class="k">New Part (Standard)</div><div class="v"><code>${get(r,"Standard")}</code></div>
              <div class="k">Details- APEX</div><div class="v">${get(r,"Details 1")}</div>
              <div class="k">Details-AS 400</div><div class="v">${get(r,"Details 2")}</div>`;
    }else if(isSP){
      body = `<div class="k">Status</div><div class="v"><b>${get(r,"Status")}</b></div>
              <div class="k">Non Standard Info</div><div class="v">${get(r,"Non Standard")}</div>
              <div class="k">Sample</div><div class="v"><code>${get(r,"Sample")}</code></div>
              <div class="k">Details- APEX</div><div class="v">${get(r,"Details 1")}</div>
              <div class="k">Details-AS 400</div><div class="v">${get(r,"Details 2")}</div>`;
    }else{
      body = `<div class="k">Status</div><div class="v"><b>${get(r,"Status")}</b></div>
              <div class="k">Details- APEX</div><div class="v">${get(r,"Details 1")}</div>
              <div class="k">Details-AS 400</div><div class="v">${get(r,"Details 2")}</div>`;
    }
    const card = document.createElement('div'); card.className='result';
    card.innerHTML = `<div class="k">Old Part#</div><div class="v"><code>${get(r,"Part#")}</code></div>
                      <div class="k">Product#</div><div class="v">${get(r,"Product#")}</div>
                      <div class="k">Product Line</div><div class="v">${get(r,"Product Line")}</div>${body}`;
    list.appendChild(card);
  }
  container.innerHTML=''; container.appendChild(list);
}

function renderNewToOld(container, inputRaw){
  const norm = normalize(inputRaw);
  document.getElementById('normPreview').textContent = norm || '—';
  if(!norm){ showMsg(container, 'Enter a new/standard part number to search.'); return; }
  const rows = STATE.mapNew.get(norm) || [];
  if(rows.length === 0){ showMsg(container, 'NEW configuration'); return; }
  const uniq = new Map();
  for(const r of rows){
    const old = String(get(r,"Part#")||"");
    if(!uniq.has(old)) uniq.set(old, {old, status:get(r,"Status"), d1:get(r,"Details 1"), d2:get(r,"Details 2")});
  }
  const data = Array.from(uniq.values());
  const table = document.createElement('table'); table.className='grid';
  table.innerHTML = `<thead><tr><th>Old Part#</th><th>Status</th><th>Details- APEX</th><th>Details-AS 400</th></tr></thead>
                     <tbody>${data.map(r=>`<tr><td><code>${r.old}</code></td><td>${r.status}</td><td>${r.d1}</td><td>${r.d2}</td></tr>`).join('')}</tbody>`;
  container.innerHTML = ''; container.appendChild(table);
}

const els = {
  tabOldNew: document.getElementById('tab-oldnew'),
  tabNewOld: document.getElementById('tab-newold'),
  q: document.getElementById('q'),
  search: document.getElementById('search'),
  results: document.getElementById('results'),
  modeName: document.getElementById('modeName'),
  normPreview: document.getElementById('normPreview'),
  rowCount: document.getElementById('rowCount'),
  badge: document.getElementById('badge'),
};

function setMode(m){
  STATE.mode = m;
  els.modeName.textContent = (m==='OLDNEW') ? 'OLD → NEW' : 'NEW → OLD';
  els.tabOldNew.classList.toggle('active', m==='OLDNEW');
  els.tabNewOld.classList.toggle('active', m==='NEWOLD');
  els.results.innerHTML = '';
}

els.tabOldNew.addEventListener('click', ()=> setMode('OLDNEW'));
els.tabNewOld.addEventListener('click', ()=> setMode('NEWOLD'));
els.search.addEventListener('click', ()=>{
  const val = els.q.value;
  if(STATE.mode==='OLDNEW') renderOldToNew(els.results, val);
  else renderNewToOld(els.results, val);
});
els.q.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ els.search.click(); } });

async function init(){
  try{
    setBadge('Loading…');
    const res = await fetch('parts.csv', {cache: 'no-store'});
    if(!res.ok) throw new Error('parts.csv not found');
    const text = await res.text();
    loadCSVText(text);
  }catch(e){
    setBadge('Error');
    showMsg(document.getElementById('results'), 'Could not load parts.csv. Ensure it is in the repo root next to index.html.');
  }
}
init();
</script>
</body>
</html>
